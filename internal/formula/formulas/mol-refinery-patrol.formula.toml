description = """
Merge queue processor patrol loop.

The Refinery processes polecat branches, merging them to their target branch one at a time with sequential rebasing.

## Variable Tracking (WRITE THESE DOWN)

| Variable | Set in step | Used in step | How to get |
|----------|-------------|--------------|------------|
| mr_id | queue-scan | close-mr, cleanup | `gt mq list` output |
| branch | queue-scan | notify-witness, cleanup | `bd show <mr_id>` → branch field |
| target | queue-scan | process-branch, merge-git | `bd show <mr_id>` → target field |
| polecat_name | queue-scan | notify-witness | Extract from branch name |
| source_issue | queue-scan | notify-witness | `bd show <mr_id>` → source_issue field |

**CRITICAL**: Write down each variable when you get it. You WILL need them in later steps.

## Merge Flow

```
Witness → MERGE_READY → Refinery → rebase → test → merge → MERGED → Witness
```

After successful merge, Refinery sends MERGED mail back to Witness for cleanup."""
formula = "mol-refinery-patrol"
version = 5

[[steps]]
id = "inbox-check"
title = "Check refinery mail"
description = """
Check mail for messages.

```bash
gt mail inbox
```

For each message type:

**MERGE_READY**: Mark as read. Work will be processed via MQ.

**PATROL: Wake up**: Archive it:
```bash
gt mail archive <message-id>
```

**HANDOFF**: Read context, then archive.

**HELP/Blocked**: Respond or escalate to Mayor, then archive."""

[[steps]]
id = "queue-scan"
title = "Scan merge queue"
needs = ["inbox-check"]
description = """
Get pending merges from MQ (source of truth).

```bash
git fetch --prune origin
gt mq list gastown
```

If queue empty → skip to context-check.

For each MR in queue:

1. Get MR details and **WRITE DOWN** these variables:
```bash
bd show <mr-id>
```
Extract from output:
- mr_id: the MR bead ID
- branch: the polecat branch name
- target: destination branch (main or integration/xxx)
- source_issue: original issue ID
- polecat_name: extract from branch (e.g., "furiosa" from "polecat/furiosa/...")

2. Verify branch exists:
```bash
git branch -r | grep <branch>
```
If branch missing → `bd close <mr-id> --reason "Branch no longer exists"`"""

[[steps]]
id = "process-branch"
title = "Rebase on target"
needs = ["queue-scan"]
description = """
Rebase polecat branch on target.

```bash
git checkout -b temp origin/<branch>
git rebase origin/<target>
```

If rebase succeeds (exit 0) → continue to run-tests.

If rebase fails (conflicts):
1. Abort: `git rebase --abort`
2. Create task:
```bash
bd create --type=task --priority=1 --title="Resolve conflicts: <source_issue>"
```
3. Skip to loop-check (do NOT close MR, do NOT delete branch)."""

[[steps]]
id = "run-tests"
title = "Run tests"
needs = ["process-branch"]
description = """
Run test suite.

```bash
go test ./...
```

Track: pass/fail count."""

[[steps]]
id = "handle-failures"
title = "Handle test failures"
needs = ["run-tests"]
description = """
If tests PASSED → continue to merge-git.

If tests FAILED:
1. Check if branch caused it or pre-existing on target
2. If branch caused → notify polecat, skip to loop-check
3. If pre-existing → fix it OR file bead:
```bash
bd create --type=bug --priority=1 --title="Test failure: <description>"
```

**GATE**: Cannot proceed without tests passing OR bead filed."""

[[steps]]
id = "merge-git"
title = "Merge and push"
needs = ["handle-failures"]
description = """
Merge temp branch to target and push.

```bash
git checkout <target>
git merge --ff-only temp
git push origin <target>
```

If push succeeds → IMMEDIATELY continue to notify-witness.
Do NOT stop here. Do NOT skip notification steps."""

[[steps]]
id = "notify-witness"
title = "Send MERGED notification"
needs = ["merge-git"]
description = """
Send MERGED notification to witness. This is REQUIRED.

```bash
gt mail send gastown/witness -s "MERGED <polecat_name>" -m "Branch: <branch>
Issue: <source_issue>
Merged-At: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
```

Without this notification, polecat worktrees accumulate forever.

After sending → IMMEDIATELY continue to close-mr."""

[[steps]]
id = "close-mr"
title = "Close MR bead"
needs = ["notify-witness"]
description = """
Close the MR bead. This is REQUIRED.

First verify merge landed:
```bash
git log origin/<target> --oneline -5 | grep "<source_issue>"
```

If verified, close:
```bash
bd close <mr_id> --reason "Merged to <target>"
```

After closing → continue to cleanup."""

[[steps]]
id = "cleanup"
title = "Delete branches"
needs = ["close-mr"]
description = """
Clean up temporary and remote branches.

```bash
git branch -d temp
git push origin --delete <branch>
```

After cleanup → continue to loop-check."""

[[steps]]
id = "loop-check"
title = "Check for more work"
needs = ["cleanup"]
description = """
More MRs in queue?

If yes → return to process-branch with next MR.
If no → continue to generate-summary.

Track for summary:
- branches_merged: count
- branches_conflict: count
- conflict_tasks: IDs created"""

[[steps]]
id = "generate-summary"
title = "Generate summary"
needs = ["loop-check"]
description = """
Summarize patrol cycle.

Include:
- Branches merged (count)
- MERGED mails sent (should match merged count)
- MR beads closed (should match merged count)
- Branches with conflicts
- Test results"""

[[steps]]
id = "context-check"
title = "Check context"
needs = ["generate-summary"]
description = """
Check context usage.

If HIGH (>80%) → prepare for handoff.
If LOW → can continue."""

[[steps]]
id = "burn-or-loop"
title = "End patrol"
needs = ["context-check"]
description = """
End patrol cycle.

If queue empty OR context HIGH:
```bash
gt handoff -s "Patrol complete" -m "Merged N branches.
Queue: empty/N remaining"
```

If queue has work AND context LOW → spawn new patrol wisp."""
